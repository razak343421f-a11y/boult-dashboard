const APPWRITE_ENDPOINT='https://sgp.cloud.appwrite.io/v1';const APPWRITE_PROJECT='6946adbc002212210938';const DATABASE_ID='YOUR_DATABASE_ID';const COLLECTION_CALLLOGS='YOUR_CALLLOGS_COLLECTION_ID';const COLLECTION_LOCATIONS='YOUR_LOCATIONS_COLLECTION_ID';const COLLECTION_DEVICESTATUS='YOUR_DEVICESTATUS_COLLECTION_ID';const COLLECTION_RECORDINGS='YOUR_RECORDINGS_COLLECTION_ID';const LOCK_PASSWORD='343421';const client=new Appwrite.Client().setEndpoint(APPWRITE_ENDPOINT).setProject(APPWRITE_PROJECT);const databases=new Appwrite.Databases(client);function buildDateQuery(dateStr,attributeName){if(!dateStr)return[];const start=new Date(dateStr);const end=new Date(dateStr);end.setHours(23,59,59,999);return[Appwrite.Query.greaterThanEqual(attributeName,start.toISOString()),Appwrite.Query.lessThanEqual(attributeName,end.toISOString())];}const lockScreen=document.getElementById('lock-screen');const lockInput=document.getElementById('lock-input');const unlockBtn=document.getElementById('unlock-btn');const lockError=document.getElementById('lock-error');const appRoot=document.getElementById('app');unlockBtn.addEventListener('click',()=>{if(lockInput.value===LOCK_PASSWORD){lockScreen.classList.add('hidden');appRoot.classList.remove('hidden');loadAllSections();}else{lockError.textContent='Incorrect password. Try again.';}});lockInput.addEventListener('keyup',(e)=>{if(e.key==='Enter'){unlockBtn.click();}});document.querySelectorAll('.tab-btn').forEach((btn)=>{btn.addEventListener('click',()=>{document.querySelectorAll('.tab-btn').forEach((b)=>b.classList.remove('active'));document.querySelectorAll('.tab-section').forEach((s)=>s.classList.remove('active'));btn.classList.add('active');document.getElementById(btn.dataset.target).classList.add('active');});});const calllogsBody=document.getElementById('calllogs-body');async function loadCallLogs(){const date=document.getElementById('calllogs-date-filter').value;const queries=buildDateQuery(date,'createdAt');try{const res=await databases.listDocuments(DATABASE_ID,COLLECTION_CALLLOGS,queries);renderCallLogs(res.documents);}catch(e){console.log('Note: Configure Appwrite credentials in main.js');renderCallLogs([]);}}function renderCallLogs(items){calllogsBody.innerHTML='';items.forEach((doc)=>{const tr=document.createElement('tr');tr.innerHTML=`<td><input type='checkbox' class='table-checkbox calllogs-select' data-id='${doc.$id}' /></td><td>${doc.number||'-'}</td><td>${doc.type||'-'}</td><td>${doc.duration||0}</td><td>${formatDateTime(doc.createdAt)}</td><td><button class='action-btn danger' data-delete-calllog='${doc.$id}'>Delete</button></td>`;calllogsBody.appendChild(tr);});}function formatDateTime(iso){if(!iso)return'-';const d=new Date(iso);return d.toLocaleDateString()+' '+d.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});}async function deleteCallLog(id){try{await databases.deleteDocument(DATABASE_ID,COLLECTION_CALLLOGS,id);loadCallLogs();}catch(e){console.log('Delete failed');}}async function deleteSelectedCallLogs(){const ids=Array.from(document.querySelectorAll('.calllogs-select:checked')).map((c)=>c.dataset.id);await Promise.all(ids.map((id)=>databases.deleteDocument(DATABASE_ID,COLLECTION_CALLLOGS,id)));loadCallLogs();}document.getElementById('calllogs-apply-filter').addEventListener('click',loadCallLogs);document.getElementById('calllogs-clear-filter').addEventListener('click',()=>{document.getElementById('calllogs-date-filter').value='';loadCallLogs();});document.getElementById('calllogs-select-all').addEventListener('click',()=>{document.querySelectorAll('.calllogs-select').forEach((c)=>c.checked=true);});document.getElementById('calllogs-deselect-all').addEventListener('click',()=>{document.querySelectorAll('.calllogs-select').forEach((c)=>c.checked=false);});document.getElementById('calllogs-delete-selected').addEventListener('click',deleteSelectedCallLogs);calllogsBody.addEventListener('click',(e)=>{const id=e.target.getAttribute('data-delete-calllog');if(id)deleteCallLog(id);});const locationsBody=document.getElementById('locations-body');let map;let markersLayer;function initMap(){if(map)return;map=L.map('map').setView([20.5937,78.9629],4);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);markersLayer=L.layerGroup().addTo(map);}async function loadLocations(){initMap();const date=document.getElementById('locations-date-filter').value;const queries=buildDateQuery(date,'createdAt');try{const res=await databases.listDocuments(DATABASE_ID,COLLECTION_LOCATIONS,queries);renderLocations(res.documents);}catch(e){renderLocations([]);}}function renderLocations(items){locationsBody.innerHTML='';markersLayer.clearLayers();items.forEach((doc)=>{const lat=doc.lat??doc.latitude;const lng=doc.lng??doc.longitude;const tr=document.createElement('tr');tr.innerHTML=`<td><input type='checkbox' class='table-checkbox locations-select' data-id='${doc.$id}' /></td><td>${lat}</td><td>${lng}</td><td>${formatDateTime(doc.createdAt)}</td><td><button class='action-btn danger' data-delete-location='${doc.$id}'>Delete</button></td>`;locationsBody.appendChild(tr);if(typeof lat==='number'&&typeof lng==='number'){const marker=L.marker([lat,lng]).addTo(markersLayer);marker.bindPopup(`<b>Location</b><br>${lat}, ${lng}<br>${formatDateTime(doc.createdAt)}`);}});if(items.length>0){const bounds=markersLayer.getBounds();if(bounds.isValid())map.fitBounds(bounds,{padding:[20,20]});}}async function deleteLocation(id){try{await databases.deleteDocument(DATABASE_ID,COLLECTION_LOCATIONS,id);loadLocations();}catch(e){}}async function deleteSelectedLocations(){const ids=Array.from(document.querySelectorAll('.locations-select:checked')).map((c)=>c.dataset.id);await Promise.all(ids.map((id)=>databases.deleteDocument(DATABASE_ID,COLLECTION_LOCATIONS,id)));loadLocations();}document.getElementById('locations-apply-filter').addEventListener('click',loadLocations);document.getElementById('locations-clear-filter').addEventListener('click',()=>{document.getElementById('locations-date-filter').value='';loadLocations();});document.getElementById('locations-select-all').addEventListener('click',()=>{document.querySelectorAll('.locations-select').forEach((c)=>c.checked=true);});document.getElementById('locations-deselect-all').addEventListener('click',()=>{document.querySelectorAll('.locations-select').forEach((c)=>c.checked=false);});document.getElementById('locations-delete-selected').addEventListener('click',deleteSelectedLocations);locationsBody.addEventListener('click',(e)=>{const id=e.target.getAttribute('data-delete-location');if(id)deleteLocation(id);});const devStatusContainer=document.getElementById('devicestatus-container');async function loadDeviceStatus(){const date=document.getElementById('devicestatus-date-filter').value;const queries=buildDateQuery(date,'createdAt');try{const res=await databases.listDocuments(DATABASE_ID,COLLECTION_DEVICESTATUS,queries);renderDeviceStatus(res.documents);}catch(e){renderDeviceStatus([]);}}function renderDeviceStatus(items){devStatusContainer.innerHTML='';items.forEach((doc)=>{const card=document.createElement('div');card.className='device-card';card.innerHTML=`<div class='device-card-header'><span class='device-label'>${doc.deviceName||'Device'}</span><span class='device-chip'>${doc.isOnline?'Online':'Offline'}</span></div><div class='device-meta'>Battery: ${doc.battery??'-'}%<br/>Network: ${doc.networkType||'-'}<br/>Updated: ${formatDateTime(doc.createdAt)}</div>`;devStatusContainer.appendChild(card);});}document.getElementById('devicestatus-apply-filter').addEventListener('click',loadDeviceStatus);document.getElementById('devicestatus-clear-filter').addEventListener('click',()=>{document.getElementById('devicestatus-date-filter').value='';loadDeviceStatus();});const recordingsBody=document.getElementById('recordings-body');async function loadRecordings(){const date=document.getElementById('recordings-date-filter').value;const queries=buildDateQuery(date,'createdAt');try{const res=await databases.listDocuments(DATABASE_ID,COLLECTION_RECORDINGS,queries);renderRecordings(res.documents);}catch(e){renderRecordings([]);}}function renderRecordings(items){recordingsBody.innerHTML='';items.forEach((doc)=>{const tr=document.createElement('tr');tr.innerHTML=`<td><input type='checkbox' class='table-checkbox recordings-select' data-id='${doc.$id}' /></td><td>${doc.number||'-'}</td><td>${doc.direction||'-'}</td><td>${doc.duration||0}</td><td>${formatDateTime(doc.createdAt)}</td><td><button class='action-btn' data-download-rec='${doc.fileId||''}'>Download</button><button class='action-btn danger' data-delete-rec='${doc.$id}'>Delete</button></td>`;recordingsBody.appendChild(tr);});}async function deleteRecording(id){try{await databases.deleteDocument(DATABASE_ID,COLLECTION_RECORDINGS,id);loadRecordings();}catch(e){}}async function deleteSelectedRecordings(){const ids=Array.from(document.querySelectorAll('.recordings-select:checked')).map((c)=>c.dataset.id);await Promise.all(ids.map((id)=>databases.deleteDocument(DATABASE_ID,COLLECTION_RECORDINGS,id)));loadRecordings();}function downloadRecording(fileId){if(!fileId)return;const url=`${APPWRITE_ENDPOINT}/storage/buckets/YOUR_BUCKET_ID/files/${fileId}/download?project=${APPWRITE_PROJECT}`;window.open(url,'_blank');}document.getElementById('recordings-apply-filter').addEventListener('click',loadRecordings);document.getElementById('recordings-clear-filter').addEventListener('click',()=>{document.getElementById('recordings-date-filter').value='';loadRecordings();});document.getElementById('recordings-select-all').addEventListener('click',()=>{document.querySelectorAll('.recordings-select').forEach((c)=>c.checked=true);});document.getElementById('recordings-deselect-all').addEventListener('click',()=>{document.querySelectorAll('.recordings-select').forEach((c)=>c.checked=false);});document.getElementById('recordings-delete-selected').addEventListener('click',deleteSelectedRecordings);recordingsBody.addEventListener('click',(e)=>{const deleteId=e.target.getAttribute('data-delete-rec');const fileId=e.target.getAttribute('data-download-rec');if(deleteId)deleteRecording(deleteId);if(fileId)downloadRecording(fileId);});function loadAllSections(){loadCallLogs();loadLocations();loadDeviceStatus();loadRecordings();}
